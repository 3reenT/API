<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My Posts</title>
    <link rel="stylesheet" href="/static/sidebar.css" />
    <style>
        body { font-family: Arial, sans-serif; background-color: #ecf0f1; margin:0; }
        .container { display: flex; }
        .content { padding:20px; margin-left:220px; width:100%; }
        h1,h2 { margin-top:0; }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:20px;
            background:#fff;
        }
        th, td {
            border:1px solid #ddd;
            padding:12px 15px;
            text-align:left;
        }
        th {
            background:#2c3e50;
            color:#fff;
        }
        tr:hover {
            background:#f2f2f2;
            cursor:pointer;
        }

        form { margin-top:20px; max-width:640px; }
        input, textarea, button { width:100%; margin-top:5px; padding:6px; box-sizing:border-box; }
        button { width:auto; cursor:pointer; }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar" id="sidebar"></div>
    <div class="content">
        <h1>Posts</h1>

        <div id="postsContainer">
            <p class="loading">Loading posts...</p>
        </div>

        <h2>Create Post</h2>
        <form id="create-post-form">
            <label>Title<br><input type="text" id="title" required></label><br>
            <label>Content<br><textarea id="content" rows="4" required></textarea></label><br>
            <label id="user-id-label">User ID<br><input type="number" id="user_id_input"></label><br>
            <button type="submit">Create Post</button>
        </form>
    </div>
</div>

<script src="/static/sidebar.js"></script>
<script>
const username = localStorage.getItem("username");
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

if(!username || !token){
    window.location.href = '/';
}

if(role !== "admin"){
    document.getElementById('user-id-label').style.display = 'none';
}

const postsContainer = document.getElementById('postsContainer');
const createForm = document.getElementById('create-post-form');
let user_id = null;
let usersMap = {}; 

async function fetchUserId(){
    if(role === "user"){
        try{
            const res = await fetch(`/users/?username=${username}`, {
                headers: { 'Authorization':'Bearer '+token }
            });
            if(!res.ok) throw new Error("Failed to fetch user info");
            const data = await res.json();
            if(data.length===0) throw new Error("User not found");
            user_id = data[0].id;
        }catch(err){
            postsContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
            console.error(err);
        }
    } else if(role === "admin"){
        try{
            const res = await fetch(`/users/`, {
                headers: { 'Authorization':'Bearer '+token }
            });
            if(!res.ok) throw new Error("Failed to fetch users");
            const data = await res.json();
            data.forEach(u => { usersMap[u.id] = u.username });
        }catch(err){
            console.error("Error fetching users: ", err);
        }
    }
}

function renderPostsTable(posts){
    const table = document.createElement("table");
    table.innerHTML = `
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Content</th>
                ${role === "admin" ? "<th>User</th>" : ""}
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector("tbody");

    posts.forEach(post=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${post.id}</td>
            <td>${post.title}</td>
            <td>${post.content}</td>
            ${role === "admin" ? `<td>${usersMap[post.user_id] || "Unknown"} (ID: ${post.user_id})</td>` : ""}
        `;
        tr.addEventListener("click", ()=>{
            window.location.href = `/static/post_detail.html?post_id=${post.id}`;
        });
        tbody.appendChild(tr);
    });

    return table;
}

async function fetchPosts(){
    try{
        let url = '';
        if(role === "admin"){
            url = '/posts/';
        } else {
            url = `/user_posts/${username}`;
        }

        const res = await fetch(url, {
            headers: { 'Authorization':'Bearer '+token }
        });
        if(!res.ok) throw new Error("Failed to fetch posts");
        const posts = await res.json();

        postsContainer.innerHTML = '';
        if(posts.length===0){
            postsContainer.innerHTML = '<p class="loading">No posts found.</p>';
            return;
        }

        postsContainer.appendChild(renderPostsTable(posts));
    }catch(err){
        postsContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
        console.error(err);
    }
}

createForm.addEventListener('submit', async(e)=>{
    e.preventDefault();
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    const userInput = document.getElementById('user_id_input').value.trim();
    const postUserId = (role === "admin" && userInput) ? Number(userInput) : user_id;

    if(!title || !content || !postUserId){ alert("Fill all required fields"); return; }

    try{
        const res = await fetch('/posts/',{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'Authorization':'Bearer '+token
            },
            body: JSON.stringify({ title, content, user_id: postUserId }) 
        });

        if(!res.ok){
            const error = await res.json();
            alert(error.detail || "Failed to create post");
            return;
        }

        createForm.reset();
        fetchPosts();
    }catch(err){
        alert("Error: "+err.message);
        console.error(err);
    }
});

fetchUserId().then(fetchPosts);
</script>
</body>
</html>
